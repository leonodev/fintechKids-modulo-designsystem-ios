name: iOS CI - Stable

on:
  pull_request:
    branches: [develop]
  push:
    branches: [develop]

jobs:
  test:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode 16.2
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'
    
    - name: Fix package path
      run: |
        mkdir -p /Users/runner/work/fintechKids-modulo-designsystem-ios
        ln -sf "$(pwd)" /Users/runner/work/fintechKids-modulo-designsystem-ios/FHKDesignSystem
    
    - name: List available simulators
      run: xcrun simctl list devices available
    
    - name: Run tests with retry and better simulator handling
      working-directory: ./Demo/FHKDesignSystemDemo
      run: |
        # Asegurarse de que el simulador esté apagado
        xcrun simctl shutdown all || true
        
        # Usar un simulador más genérico y disponible
        xcodebuild test \
          -project FHKDesignSystemDemo.xcodeproj \
          -scheme FHKDesignSystemDemo \
          -destination 'platform=iOS Simulator,id=Booted' \
          -destination-timeout 10 \
          CODE_SIGNING_ALLOWED=NO \
          -quiet
        
        echo "✅ Tests passed!"
      
    - name: If tests fail, try with specific iPhone
      if: failure()
      working-directory: ./Demo/FHKDesignSystemDemo
      run: |
        echo "Trying with specific iPhone 15..."
        xcodebuild test \
          -project FHKDesignSystemDemo.xcodeproj \
          -scheme FHKDesignSystemDemo \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          CODE_SIGNING_ALLOWED=NO \
          -retry-tests-on-failure \
          -maximum-test-execution-time-allowance 30
        
        echo "✅ Tests passed on retry!"
