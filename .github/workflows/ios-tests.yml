name: iOS Design System CI

on:
  pull_request:
    branches: [develop]
  push:
    branches: [develop]

jobs:
  test:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode 16.2
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'
    
    # PASO CR√çTICO: Cambiar .v26 a .v18 usando PERL (m√°s confiable)
    - name: Fix Package.swift iOS version
      run: |
        echo "üîß REPLACING .iOS(.v26) with .iOS(.v18) in Package.swift..."
        
        # Mostrar el archivo antes
        echo "=== Package.swift BEFORE ==="
        head -15 Package.swift
        
        # Usar perl para reemplazar - funciona mejor en macOS
        perl -i -pe 's/\.iOS\(\.v26\)/.iOS(.v18)/g' Package.swift
        
        # Verificar el cambio
        echo ""
        echo "=== Package.swift AFTER ==="
        head -15 Package.swift
        
        # Confirmar que el cambio se hizo
        if grep -q "\.iOS(\.v18)" Package.swift; then
          echo "‚úÖ SUCCESS: Package.swift fixed for CI"
        else
          echo "‚ùå ERROR: Failed to fix Package.swift"
          echo "Current line 9:"
          sed -n '9p' Package.swift
          exit 1
        fi
    
    - name: Fix package path for demo
      run: |
        mkdir -p /Users/runner/work/fintechKids-modulo-designsystem-ios
        ln -sf "$(pwd)" /Users/runner/work/fintechKids-modulo-designsystem-ios/FHKDesignSystem
    
    # PRIMERO: Solo verificar que el paquete se puede construir
    - name: Build Swift Package (check only)
      run: |
        echo "üî® Building Swift Package to check compatibility..."
        swift build
        
        echo "‚úÖ Swift package builds successfully"
    
    # SEGUNDO: Probar el demo (esto sabemos que funciona)
    - name: Test Demo App  
      working-directory: ./Demo/FHKDesignSystemDemo
      run: |
        echo "üöÄ Testing Demo App..."
        xcodebuild test \
          -project FHKDesignSystemDemo.xcodeproj \
          -scheme FHKDesignSystemDemo \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          CODE_SIGNING_ALLOWED=NO
        echo "‚úÖ Demo tests passed!"
