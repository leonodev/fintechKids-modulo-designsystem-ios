name: iOS Design System CI

on:
  pull_request:
    branches: [develop]
  push:
    branches: [develop]

jobs:
  test:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode 16.2 and select it
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'
    
    # PASO CR√çTICO: Forzar uso del Swift de Xcode, no del sistema
    - name: Force Xcode's Swift version
      run: |
        # Esto hace que 'swift' use el toolchain de Xcode 16.2
        sudo xcode-select -s /Applications/Xcode_16.2.app
        
        # Verificar
        echo "Swift version being used:"
        /usr/bin/xcrun swift --version
    
    - name: Fix package path for demo
      run: |
        mkdir -p /Users/runner/work/fintechKids-modulo-designsystem-ios
        ln -sf "$(pwd)" /Users/runner/work/fintechKids-modulo-designsystem-ios/FHKDesignSystem
    
    # PRIMERO: Probar el paquete Swift 6.2
    - name: Test Swift 6.2 Package
      run: |
        echo "üß™ Testing Swift 6.2 Package..."
        /usr/bin/xcrun swift test --parallel
        echo "‚úÖ Swift 6.2 package tests passed!"
    
    # SEGUNDO: Probar el demo
    - name: Test Demo App  
      working-directory: ./Demo/FHKDesignSystemDemo
      run: |
        echo "üöÄ Testing Demo App..."
        xcodebuild test \
          -project FHKDesignSystemDemo.xcodeproj \
          -scheme FHKDesignSystemDemo \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          CODE_SIGNING_ALLOWED=NO
        echo "‚úÖ Demo tests passed!"
